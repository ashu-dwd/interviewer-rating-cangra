<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interviewer Evaluation</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h2 class="mb-4 text-center">
        <i class="fas fa-user-tie me-2"></i>Interviewer Evaluation Form
      </h2>

      <form id="evaluationForm">
        <div class="input-container">
          <div class="mb-3">
            <label for="candidateName" class="form-label">
              <i class="fas fa-user me-2"></i>Candidate Name:
            </label>
            <input
              type="text"
              class="form-control"
              id="candidateName"
              name="candidateName"
              required
            />
          </div>

          <div class="mb-3">
            <label for="candidateExperience" class="form-label">
              <i class="fas fa-briefcase me-2"></i>Candidate Experience (years):
            </label>
            <input
              type="text"
              class="form-control"
              id="candidateExperience"
              name="candidateExperience"
              required
            />
          </div>

          <div class="mb-3">
            <label for="skillsToRate" class="form-label">
              <i class="fas fa-code me-2"></i>Skills to Rate:
            </label>
            <textarea
              class="form-control"
              id="skillsToRate"
              name="skillsToRate"
              required
            ></textarea>
            <div class="form-text">Enter skills separated by commas</div>
          </div>

          <div class="mb-3">
            <label for="mandatorySkills" class="form-label">
              <i class="fas fa-exclamation-circle me-2"></i>Mandatory Skills:
            </label>
            <textarea
              class="form-control"
              id="mandatorySkills"
              name="mandatorySkills"
              required
            ></textarea>
            <div class="form-text">Skills that are absolutely required</div>
          </div>

          <div class="mb-3">
            <label for="interviewTranscript" class="form-label">
              <i class="fas fa-file-alt me-2"></i>Interview Transcript:
            </label>
            <textarea
              class="form-control"
              id="interviewTranscript"
              name="interviewTranscript"
              rows="5"
              required
            ></textarea>
          </div>

          <button type="submit" class="btn btn-primary" id="evaluateBtn">
            <i class="fas fa-chart-bar me-2"></i>Evaluate Interview
          </button>
        </div>
      </form>

      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Analyzing interview data...</p>
      </div>

      <!-- Modal -->
      <div
        class="modal fade"
        id="evaluationModal"
        tabindex="-1"
        aria-labelledby="evaluationModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="evaluationModalLabel">
                <i class="fas fa-clipboard-check me-2"></i>Interview Evaluation
                Results
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div
              class="modal-body"
              id="modalContent"
              style="overflow-y: auto; max-height: 400px"
            >
              <!-- Evaluation results will be inserted here -->
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary no-print"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-times me-2"></i>Close
              </button>
              <button
                type="button"
                class="btn btn-primary no-print"
                id="printBtn"
              >
                <i class="fas fa-print me-2"></i>Print
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden container for PDF generation -->
      <div
        id="pdfContainer"
        style="position: absolute; left: -9999px; top: -9999px"
      ></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      $(document).ready(function () {
        // Configuration
        const API_BASE_URL = window.location.origin + "/api/v1";
        const evaluationModal = new bootstrap.Modal(
          document.getElementById("evaluationModal")
        );

        // Initialize loading spinner as hidden
        $("#loadingSpinner").hide();

        // Form submission handler
        $("#evaluationForm").on("submit", function (e) {
          e.preventDefault();

          const $submitBtn = $("#evaluateBtn");
          $submitBtn.prop("disabled", true);
          $("#loadingSpinner").show();

          // Sanitize inputs
          const sanitizeInput = (input) => {
            if (typeof input === "string") {
              return input.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }
            return input;
          };

          // Prepare request data
          const requestData = {
            candidateName: sanitizeInput($("#candidateName").val()),
            candidateExperience: sanitizeInput($("#candidateExperience").val()),
            skillsToRate: sanitizeInput($("#skillsToRate").val()),
            mandatorySkills: sanitizeInput($("#mandatorySkills").val()),
            interviewTranscript: sanitizeInput($("#interviewTranscript").val()),
          };

          // API call
          $.ajax({
            url: `${API_BASE_URL}/gen`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(requestData),
            success: function (response) {
              $("#loadingSpinner").hide();
              $submitBtn.prop("disabled", false);
              console.log(response);

              if (!response.success) {
                displayErrorMessage(response.message || "Request failed");
                return;
              }

              try {
                displayEvaluationResults(response.data);
                evaluationModal.show();
              } catch (error) {
                console.error("Error processing response:", error);
                displayErrorMessage(
                  "There was an error processing the evaluation results."
                );
              }
            },
            error: function (xhr, status, error) {
              $("#loadingSpinner").hide();
              $submitBtn.prop("disabled", false);

              let errorMsg = "There was a problem processing your request.";
              if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
              }
              displayErrorMessage(errorMsg, error);
            },
          });
        });

        // Print button handler - Fixed for capturing full content
        $("#printBtn").on("click", function () {
          const contentHTML = $("#modalContent").html();
          const $pdfContainer = $("#pdfContainer");

          // Clone the content into our hidden container without height restrictions
          $pdfContainer.html(contentHTML);
          $pdfContainer.css({
            width: "800px", // Set a fixed width for better PDF formatting
            "background-color": "#fff",
            padding: "20px",
            display: "block", // Make sure it's visible for html2canvas
            position: "absolute",
            left: "-9999px", // Out of normal view
            top: "-9999px", // Out of normal view
          });

          // Remove any max-height restrictions
          $pdfContainer.find("[style*='max-height']").css("max-height", "none");
          $pdfContainer.find("[style*='overflow']").css("overflow", "visible");

          // Allow the DOM to update before capturing
          setTimeout(function () {
            html2canvas($pdfContainer[0], {
              logging: false,
              useCORS: true,
              scale: 2, // Improve quality
              windowWidth: 800,
              scrollY: 0,
              scrollX: 0,
              onclone: function (clonedDoc) {
                // Additional processing of cloned document if needed
                $(clonedDoc).find("#pdfContainer").css({
                  position: "static",
                  left: "auto",
                  top: "auto",
                });
              },
            }).then(function (canvas) {
              const imgData = canvas.toDataURL("image/png");
              const { jsPDF } = window.jspdf;

              // Calculate dimensions while keeping aspect ratio
              const pdfWidth = 210; // A4 width in mm
              const pdfHeight = 297; // A4 height in mm
              const imgWidth = pdfWidth;
              const imgHeight = (canvas.height * imgWidth) / canvas.width;

              // Create PDF with multiple pages if content is too tall
              const pdf = new jsPDF("p", "mm", "a4");

              // Add image across multiple pages if necessary
              let heightLeft = imgHeight;
              let position = 0;
              let pageHeight = pdfHeight - 20; // Margin

              // First page
              pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
              heightLeft -= pageHeight;

              // Additional pages if needed
              while (heightLeft > 0) {
                position = heightLeft - imgHeight; // Negative value
                pdf.addPage();
                pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
              }

              pdf.save($("#candidateName").val() + "_" + Date.now() + ".pdf");

              // Clean up
              $pdfContainer.html("");
            });
          }, 500);
        });

        // Helper function to display error messages
        function displayErrorMessage(message, details = "") {
          const errorHtml = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Error:</strong> ${message}
                        ${
                          details
                            ? `<br><br><small>Technical details: ${details}</small>`
                            : ""
                        }
                    </div>
                `;
          $("#modalContent").html(errorHtml);
          evaluationModal.show();
        }

        // Helper function to get score styling class
        function getScoreClass(score) {
          if (!score && score !== 0) return "bg-secondary text-white";
          if (score >= 1 && score <= 3) return "bg-danger text-white";
          if (score >= 4 && score <= 6) return "bg-warning text-dark";
          return "bg-success text-white";
        }

        // Helper function to get score color
        function getScoreColor(score) {
          if (!score && score !== 0) return "#6c757d";
          if (score >= 1 && score <= 3) return "#dc3545";
          if (score >= 4 && score <= 6) return "#ffc107";
          return "#198754";
        }

        // Helper function to safely access nested object properties
        function safeGet(obj, path, fallback = "N/A") {
          if (!obj) return fallback;
          const keys = path.split(".");
          return keys.reduce(
            (acc, key) => (acc && acc[key] !== undefined ? acc[key] : fallback),
            obj
          );
        }

        // Main function to display evaluation results
        function displayEvaluationResults(data) {
          if (!data || typeof data !== "object") {
            displayErrorMessage(
              "Received invalid data format from the server."
            );
            console.error("Invalid data format:", data);
            return;
          }

          let html = `
                    <div class="container-fluid p-0">
                        <!-- Overall Rating -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-star me-2"></i>Overall Rating
                            </div>
                            <div class="card-body">`;

          // Overall Rating Section
          if (data.overall_rating) {
            const overallScore = safeGet(data, "overall_rating.score");
            const scoreBadgeClass = getScoreClass(overallScore);
            html += `
                                <div class="d-flex align-items-center mb-3">
                                    <div class="score-badge ${scoreBadgeClass}">${overallScore}</div>
                                    <h5 class="mb-0">Overall Score</h5>
                                </div>
                                <p>${safeGet(
                                  data,
                                  "overall_rating.summary",
                                  "No summary available."
                                )}</p>`;
          } else {
            html += `<p class="alert alert-warning">No overall rating available</p>`;
          }

          html += `
                            </div>
                        </div>
                        
                        <!-- Category Ratings -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-list-check me-2"></i>Category Ratings
                            </div>
                            <div class="card-body">`;

          // Category Ratings Section
          if (
            data.category_ratings &&
            typeof data.category_ratings === "object"
          ) {
            for (const [category, rating] of Object.entries(
              data.category_ratings
            )) {
              const score =
                rating && rating.score !== undefined ? rating.score : "N/A";
              const feedback =
                rating && rating.feedback
                  ? rating.feedback
                  : "No feedback available";
              const scoreColor = getScoreColor(score);

              html += `
                                <div class="category-rating mb-3 p-3 border-start border-4" style="border-color: ${scoreColor}">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="score-badge ${getScoreClass(
                                          score
                                        )} me-3">${score}</div>
                                        <h5 class="mb-0 text-capitalize">${category.replace(
                                          /_/g,
                                          " "
                                        )}</h5>
                                    </div>
                                    <p class="mb-0">${feedback}</p>
                                </div>`;
            }
          } else {
            html += `<p class="alert alert-warning">No category ratings available</p>`;
          }

          html += `
                            </div>
                        </div>`;

          // Dynamic Sections (Strengths, Improvements, etc.)
          const sections = [
            {
              key: "strengths",
              title: "Strengths",
              icon: "fa-thumbs-up",
              colorClass: "success",
              listClass: "",
            },
            {
              key: "improvement_areas",
              title: "Improvement Areas",
              icon: "fa-exclamation-triangle",
              colorClass: "warning",
              listClass: "",
            },
            {
              key: "missed_skills",
              title: "Missed Skills",
              icon: "fa-times-circle",
              colorClass: "danger",
              listClass: "missed-skills",
            },
            {
              key: "recommendations",
              title: "Recommendations",
              icon: "fa-lightbulb",
              colorClass: "info",
              listClass: "",
            },
          ];

          sections.forEach((section) => {
            if (
              data[section.key] &&
              Array.isArray(data[section.key]) &&
              data[section.key].length > 0
            ) {
              html += `
                        <!-- ${section.title} -->
                        <div class="card mb-4">
                            <div class="card-header bg-${
                              section.colorClass
                            } text-${
                section.colorClass === "warning" ? "dark" : "white"
              }">
                                <i class="fas ${section.icon} me-2"></i>${
                section.title
              }
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush ${
                                  section.listClass
                                }">`;

              data[section.key].forEach((item) => {
                html += `
                                    <li class="list-group-item">
                                        <i class="fas ${
                                          section.key === "strengths"
                                            ? "fa-check-circle"
                                            : section.key ===
                                              "improvement_areas"
                                            ? "fa-tools"
                                            : section.key === "missed_skills"
                                            ? "fa-minus-circle"
                                            : "fa-arrow-right"
                                        } text-${section.colorClass} me-2"></i>
                                        ${item}
                                    </li>`;
              });

              html += `
                                </ul>
                            </div>
                        </div>`;
            }
          });

          html += `</div>`;

          $("#modalContent").html(html);
        }
      });
    </script>
  </body>
</html>
